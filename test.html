<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>生成测验 JSON</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .question, .answer {
      margin-bottom: 15px;
    }
    .answer input {
      margin-left: 10px;
    }
    .upload-preview {
      margin-top: 10px;
      max-width: 300px;
      max-height: 300px;
    }
  </style>
</head>
<body>
<h1>生成测验 JSON</h1>
<form id="quizForm" enctype="multipart/form-data">
  <label for="title">标题: </label>
  <input type="text" id="title" name="title" placeholder="请输入测验标题"><br><br>

  <label for="mainPic">封面图片 (上传图片): </label>
  <input type="file" id="mainPic" name="mainPic" accept="image/*"><br><br>
  <img id="mainPicPreview" class="upload-preview" src="" alt="封面图片预览"><br><br>

  <label for="thems">标签 (用逗号分隔): </label>
  <input type="text" id="thems" name="thems" placeholder="请输入标签"><br><br>

  <div id="questionsContainer">
    <div class="question" id="question_1">
      <h3>问题 1</h3>
      <label for="questionText_1">问题内容: </label>
      <input type="text" id="questionText_1" placeholder="请输入问题内容"><br><br>

      <label for="questionPic_1">问题图片 (上传图片): </label>
      <input type="file" id="questionPic_1" name="questionPic_1" accept="image/*"><br><br>
      <img id="questionPicPreview_1" class="upload-preview" src="" alt="问题图片预览"><br><br>

      <div class="answer">
        <label for="answer1_1">答案 1: </label>
        <input type="text" id="answer1_1" placeholder="请输入答案 1"><br><br>
        <label for="answer2_1">答案 2: </label>
        <input type="text" id="answer2_1" placeholder="请输入答案 2"><br><br>
        <label for="answer3_1">答案 3: </label>
        <input type="text" id="answer3_1" placeholder="请输入答案 3"><br><br>
        <label for="answer4_1">答案 4: </label>
        <input type="text" id="answer4_1" placeholder="请输入答案 4"><br><br>
      </div>
    </div>
  </div>
  <button type="button" onclick="addQuestion()">添加问题</button><br><br>
  <button type="submit">生成 JSON</button>
</form>

<h2>生成的 JSON:</h2>
<pre id="jsonOutput"></pre>

<script>
  let questionCount = 1;
  let quizData = {
    title: '',
    mainPic: '',
    thems: [],
    questions: [],
    toAnswer: 10059
  };

  // 处理封面图片上传预览
  document.getElementById('mainPic').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById('mainPicPreview').src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  });

  // 处理问题图片上传预览
  function handleQuestionPicUpload(event, questionId) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        document.getElementById(`questionPicPreview_${questionId}`).src = e.target.result;
      };
      reader.readAsDataURL(file);
    }
  }

  function addQuestion() {
    questionCount++;
    const questionDiv = document.createElement('div');
    questionDiv.classList.add('question');
    questionDiv.id = `question_${questionCount}`;
    questionDiv.innerHTML = `
                <h3>问题 ${questionCount}</h3>
                <label for="questionText_${questionCount}">问题内容: </label>
                <input type="text" id="questionText_${questionCount}" placeholder="请输入问题内容"><br><br>

                <label for="questionPic_${questionCount}">问题图片 (上传图片): </label>
                <input type="file" id="questionPic_${questionCount}" name="questionPic_${questionCount}" accept="image/*"><br><br>
                <img id="questionPicPreview_${questionCount}" class="upload-preview" src="" alt="问题图片预览"><br><br>

                <div class="answer">
                    <label for="answer1_${questionCount}">答案 1: </label>
                    <input type="text" id="answer1_${questionCount}" placeholder="请输入答案 1"><br><br>
                    <label for="answer2_${questionCount}">答案 2: </label>
                    <input type="text" id="answer2_${questionCount}" placeholder="请输入答案 2"><br><br>
                    <label for="answer3_${questionCount}">答案 3: </label>
                    <input type="text" id="answer3_${questionCount}" placeholder="请输入答案 3"><br><br>
                    <label for="answer4_${questionCount}">答案 4: </label>
                    <input type="text" id="answer4_${questionCount}" placeholder="请输入答案 4"><br><br>
                </div>
            `;
    document.getElementById('questionsContainer').appendChild(questionDiv);

    // 为新增问题的图片上传添加事件监听
    document.getElementById(`questionPic_${questionCount}`).addEventListener('change', function(event) {
      handleQuestionPicUpload(event, questionCount);
    });
  }

  document.getElementById('quizForm').addEventListener('submit', function(event) {
    event.preventDefault();

    quizData.title = document.getElementById('title').value;

    // 处理封面图片路径
    const mainPicFile = document.getElementById('mainPic').files[0];
    if (mainPicFile) {
      const formData = new FormData();
      formData.append("file", mainPicFile);
      // 将文件上传到服务器（假设上传路径为"/upload"）
      fetch("/upload", {
        method: "POST",
        body: formData
      })
              .then(response => response.json())
              .then(data => {
                quizData.mainPic = data.filePath;  // 假设返回JSON包含filePath字段
                generateJSON();
              })
              .catch(error => {
                console.error('文件上传失败:', error);
              });
    } else {
      quizData.mainPic = "";
      generateJSON();
    }

    quizData.thems = document.getElementById('thems').value.split(',');

    quizData.questions = [];
    for (let i = 1; i <= questionCount; i++) {
      let questionObj = {
        question: document.getElementById(`questionText_${i}`).value,
        pic: "",
        answers: []
      };

      // 处理问题图片路径
      const questionPicFile = document.getElementById(`questionPic_${i}`).files[0];
      if (questionPicFile) {
        const formData = new FormData();
        formData.append("file", questionPicFile);
        // 将文件上传到服务器（假设上传路径为"/upload"）
        fetch("/upload", {
          method: "POST",
          body: formData
        })
                .then(response => response.json())
                .then(data => {
                  questionObj.pic = data.filePath;  // 假设返回JSON包含filePath字段
                  quizData.questions.push(questionObj);
                })
                .catch(error => {
                  console.error('文件上传失败:', error);
                });
      }

      for (let j = 1; j <= 4; j++) {
        let answerObj = {
          answer: document.getElementById(`answer${j}_${i}`).value,
          aPic: "",
          aId: j
        };
        questionObj.answers.push(answerObj);
      }
    }
  });

  function generateJSON() {
    // 生成并显示JSON
    document.getElementById('jsonOutput').textContent = JSON.stringify(quizData, null, 2);
  }
</script>
</body>
</html>
